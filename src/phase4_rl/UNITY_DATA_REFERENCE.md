# Unity Episode Data Reference

## Overview
This document describes the exact data format generated by the Phase 4 RL system for Unity replay visualization.

**IMPORTANT**: This is now a **full 6DOF 3D simulation** with true 3D physics, quaternion rotations, and realistic flight dynamics.

## File Structure
```
my_runs/
└── run_2025-08-04-HHMMSS/
    ├── manifest.json          # Episode index and metadata
    ├── ep_000001.jsonl        # Episode 1 timestep data
    ├── ep_000002.jsonl        # Episode 2 timestep data
    └── ...
```

## Coordinate System
- **Simulation**: Full 6DOF 3D with realistic physics
- **Frame**: ENU_RH (East-North-Up, Right-Handed) 
- **X**: East (positive = right)
- **Y**: North (positive = forward)
- **Z**: Up (positive = upward)
- **Units**: meters, seconds, radians, kg, newtons

**Unity Mapping**:
```
Unity.X = Python.X  (East)
Unity.Y = Python.Z  (Up) 
Unity.Z = Python.Y  (North)
```

## Manifest.json Schema
```json
{
  "schema_version": "1.0",
  "coord_frame": "ENU_RH",
  "units": {"pos": "m", "vel": "m/s", "ang": "rad", "time": "s"},
  "dt_nominal": 0.01,
  "gravity": [0.0, 0.0, -9.81],
  "episodes": [
    {
      "id": "ep_000001",
      "file": "ep_000001.jsonl",
      "seed": 12345,
      "scenario": "easy",
      "notes": "FastSimEnv training episode"
    }
  ]
}
```

## Episode File Format (JSONL)

### Line 1: Header
```json
{
  "t": 0.0,
  "meta": {
    "ep_id": "ep_000001",
    "seed": 12345,
    "coord_frame": "ENU_RH",
    "dt_nominal": 0.01,
    "scenario": "easy"
  },
  "scene": {
    "interceptor_0": {
      "mass_kg": 10.0,
      "max_torque": [8000, 8000, 2000],
      "sensor_fov_deg": 30.0,
      "max_thrust_n": 1000.0
    },
    "threat_0": {
      "type": "ballistic",
      "mass_kg": 100.0,
      "aim_point": [0, 0, 0]
    }
  }
}
```

### Lines 2-N: Timestep Data
```json
{
  "t": 1.23,
  "agents": {
    "interceptor_0": {
      "p": [100.5, 200.3, 0.0],         // Position [x, y, z] in meters
      "q": [1.0, 0.0, 0.0, 0.0],        // Quaternion [w, x, y, z] 
      "v": [10.2, 5.1, 0.0],            // Velocity [vx, vy, vz] in m/s
      "w": [0.0, 0.0, 0.1],             // Angular velocity [wx, wy, wz] in rad/s
      "u": [0.5, 0.3, 0.0, 0.0, 0.0, 0.8], // Action vector (6 elements)
      "fuel_kg": 85.3,                 // Fuel remaining in kg
      "status": "active"                // "active" | "destroyed" | "finished"
    },
    "threat_0": {
      "p": [500.1, 600.2, 0.0],
      "q": [0.924, 0.0, 0.0, 0.383],
      "v": [-50.0, -40.0, 0.0],
      "w": [0.0, 0.0, 0.0],
      "status": "active"
    }
  },
  "events": []                          // Optional discrete events
}
```

### Final Line: Summary
```json
{
  "t": 12.37,
  "summary": {
    "outcome": "hit",                   // "hit" | "miss" | "timeout"
    "miss_distance_m": 2.1,            // Closest approach distance
    "impact_time_s": 11.94,            // Time of impact/closest approach
    "episode_duration": 12.37,         // Total episode time
    "notes": "Episode ended after 124 steps"
  }
}
```

## Agent Data Fields

### Position (p)
- **Type**: `[float, float, float]`
- **Units**: meters
- **Description**: Full 3D position `[x, y, z]` in ENU coordinates
- **Range**: X,Y: -1000 to +1000 meters; Z: 0 to 1000 meters (altitude)

### Quaternion (q)
- **Type**: `[float, float, float, float]`
- **Format**: `[w, x, y, z]` (scalar-first)
- **Constraint**: Normalized unit quaternion (magnitude = 1.0)
- **Description**: True 3D orientation from physics simulation

### Velocity (v)
- **Type**: `[float, float, float]`
- **Units**: m/s
- **Description**: Full 3D velocity `[vx, vy, vz]` in ENU coordinates
- **Range**: Typically -300 to +300 m/s (includes gravity effects)

### Angular Velocity (w)
- **Type**: `[float, float, float]`
- **Units**: rad/s
- **Range**: Typically -10 to +10 rad/s
- **Description**: True angular velocity from 6DOF physics simulation

### Action (u)
- **Type**: `[float, float, float, float, float, float]`
- **Range**: -1.0 to +1.0 (normalized)
- **Description**: True 6DOF control input from RL agent
- **Elements**: `[thrust_x, thrust_y, thrust_z, torque_x, torque_y, torque_z]`
- **Physics**: Body-frame forces and torques applied to interceptor

### Fuel (fuel_kg)
- **Type**: `float`
- **Units**: kilograms
- **Range**: 0.0 to 100.0
- **Description**: Remaining fuel mass

### Status
- **Type**: `string`
- **Values**: `"active"`, `"destroyed"`, `"finished"`
- **Description**: Current agent state

## Sampling Rate
- **Frequency**: 100 Hz (0.01s timesteps)
- **Duration**: Typically 10-30 seconds per episode
- **Records**: ~1000-3000 timestep records per episode

## Unity Implementation Notes

1. **Streaming**: Read JSONL files line-by-line for memory efficiency
2. **Interpolation**: Linear interpolation between timesteps if needed
3. **Coordinate Transform**: Apply ENU→Unity mapping on load
4. **Quaternion**: Use Unity's Quaternion(x,y,z,w) constructor (note order)
5. **Trails**: Use position history for visual trails
6. **HUD**: Display fuel, velocity, status from agent data
7. **Events**: Process events array for discrete effects (explosions, etc.)

## Data Validation
- Timestamps are monotonic increasing
- Quaternions are normalized (±0.001 tolerance)
- No NaN or Inf values
- Position values within reasonable bounds
- Status transitions are logical (active→destroyed, etc.)

## File Sizes
- **Episode**: ~0.5-2 MB per episode (depends on duration)
- **Manifest**: <1 KB
- **Total**: ~50-200 MB for 100 episodes