# Hlynr Intercept Configuration

# Environment settings
environment:
  dt: 0.01  # Simulation timestep (100Hz)
  max_steps: 2000  # 20 seconds - allows time for search -> track -> intercept
  max_range: 10000.0  # Maximum radar range (m)
  max_velocity: 1000.0  # Maximum velocity for normalization (m/s)

  # Realistic ballistic missile defense geometry
  # DEFENDED TARGET: Origin point (city/installation to protect)
  # INTERCEPTOR: Launches FROM the defended target location (ground-based defense)
  # THREAT: Incoming ballistic missile from distance, high altitude, descending toward target
  target_position: [0, 0, 0]  # Defended target at origin (e.g., city center)

  # Interceptor launches from defended target location (realistic BMD)
  interceptor_spawn:
    position: [[0, 0, 0], [50, 50, 10]]  # Launch from target area, ground level
    velocity: [[20, 20, 40], [40, 40, 80]]  # Initial launch velocity

  # Incoming ballistic missile - mid-range threat
  # Reduced from 4-7km to 2-4km to make learning feasible with current physics
  missile_spawn:
    position: [[1500, 1500, 1500], [3000, 3000, 3000]]  # 2-4km away, 1.5-3km altitude
    velocity: [[-100, -100, -50], [-150, -150, -70]]  # Descending toward origin
  
  # Physics
  gravity: [0, 0, -9.81]  # m/s^2
  drag_coefficient: 0.3
  air_density: 1.225  # kg/m^3 at sea level
  
  # Wind
  wind:
    velocity: [5.0, 0.0, 0.0]  # Base wind velocity (m/s)
    variability: 0.1  # Wind variation factor
  
  # Onboard Radar system
  radar_range: 8000.0  # Maximum radar detection range (m) - increased to detect threats at spawn
  radar_noise: 0.05  # Radar measurement noise level
  radar_quality: 1.0  # Initial radar quality (0-1)
  radar_beam_width: 60.0  # Radar beam width in degrees
  min_detection_range: 50.0  # Minimum range for accurate tracking

  # Ground-Based Radar Array (AN/TPY-2 THAAD-style)
  ground_radar:
    enabled: true  # Enable ground radar support
    position: [0, 0, 100]  # Ground radar location (100m tower near defended target)

    # Detection capabilities
    max_range: 20000.0  # 20km tracking range (much longer than onboard)
    min_elevation_angle: 5.0  # degrees (cannot see below horizon)
    max_elevation_angle: 85.0  # degrees (near-zenith coverage)

    # Measurement accuracy (better than onboard due to larger aperture)
    range_accuracy: 10.0  # meters RMS
    velocity_accuracy: 2.0  # m/s RMS

    # Environmental factors
    base_quality: 0.95  # High-quality ground installation
    weather_sensitivity: 0.2  # Degradation factor in bad weather

    # Data link (ground-to-interceptor communication)
    max_datalink_range: 50000.0  # 50km comm range
    datalink_packet_loss: 0.05  # 5% packet loss rate
    ground_sensor_delay_ms: 50.0  # Ground radar delay (processing + transmission)
  
  # Missile behavior
  missile_evasion: false  # Enable missile evasion maneuvers

# Curriculum Learning Configuration
# OPTIMIZED: Very slow progression to ensure policy masters each difficulty level
# Strategy: Train on easy until 80%+ success, then gradually increase difficulty
curriculum:
  enabled: true  # ENABLED but FROZEN at easy difficulty
  initial_radius: 200.0  # FROZEN: Train at 200m radius throughout
  final_radius: 200.0  # FROZEN: Stay at 200m (was 20m - too aggressive)

  # FROZEN CURRICULUM: Train at easy difficulty until policy masters basics
  # Previous runs failed because curriculum shrank too fast (200m -> 20m)
  # Policy never learned fundamentals before difficulty increased
  curriculum_steps: 15000000  # Extended to match full training duration

  # Curriculum-based radar difficulty progression (radar-only, no omniscient data)
  # STAGED TRANSITIONS: Each difficulty factor increases independently and slowly
  radar_curriculum:
    enabled: true

    # STAGE 1: Beam width narrowing (8M-12M steps, after policy is stable)
    initial_beam_width: 120.0  # Wide beam for initial acquisition
    final_beam_width: 60.0     # Narrow beam for realistic tracking
    beam_width_transition_start: 8000000   # Start at 8M (53% of training)
    beam_width_transition_end: 12000000    # Finish at 12M (80% of training)

    # STAGE 2: Detection reliability degradation (12M-14M steps, after beam stable)
    initial_detection_reliability: 1.0   # Perfect detection initially
    final_detection_reliability: 0.75    # Realistic 75% base reliability
    reliability_transition_start: 12000000  # Start at 12M (80% of training)
    reliability_transition_end: 14000000    # Finish at 14M (93% of training)

    # STAGE 2: Ground radar reliability (synchronized with onboard)
    initial_ground_reliability: 1.0      # Perfect ground radar initially
    final_ground_reliability: 0.85       # Realistic 85% base reliability
    ground_reliability_transition_start: 12000000
    ground_reliability_transition_end: 14000000

    # STAGE 3: Measurement noise (14M-15M steps, final challenge)
    initial_noise_level: 0.0    # No measurement noise initially
    final_noise_level: 0.05     # Realistic 5% measurement noise
    noise_transition_start: 14000000  # Start at 14M (93% of training)
    noise_transition_end: 15000000    # Finish at 15M (100% of training)

# Training configuration
training:
  # Algorithm parameters - OPTIMIZED for LSTM-based policy with dense rewards
  total_timesteps: 10000000  # FULL RUN: 10M steps for LSTM convergence with dense rewards
  n_envs: 16  # Parallel environments for sampling

  # LSTM Policy Configuration (handles partial observability from radar)
  use_lstm: true  # Enable LSTM for temporal integration of radar observations
  lstm_hidden_size: 256  # LSTM hidden state size (matches network size for efficiency)
  n_lstm_layers: 1  # Single LSTM layer (sufficient for this task)
  enable_critic_lstm: true  # LSTM for both policy and value function

  # OPTIMIZATION: Learning rate for LSTM (slightly lower for stability)
  learning_rate: 0.0002  # 2e-4 (reduced for LSTM stability)

  # OPTIMIZATION: Rollout and batch size optimized for LSTM
  n_steps: 1024  # Shorter rollouts for LSTM (reduces memory, speeds backprop through time)
  batch_size: 128  # Smaller batches for LSTM (memory constraints)
  n_epochs: 10  # Epochs per rollout

  # OPTIMIZATION: Conservative value estimates for early training stability
  gamma: 0.99  # Sharper discounting for better convergence
  gae_lambda: 0.95  # Less trust in value function during early training

  clip_range: 0.2
  ent_coef: 0.01  # Will be dynamically scheduled
  vf_coef: 0.5  # REVERTED from 1.0 - doubling made things worse (18% vs 33%)
  max_grad_norm: 0.5

  # Network architecture - OPTIMIZED for LSTM policy
  # LSTM adds temporal integration capacity, so MLP layers can be moderate size
  # 26D input -> LSTM(256) -> [256, 256] -> 6D output
  # Total params: ~400k (LSTM adds ~260k, MLPs add ~140k)
  net_arch: [256, 256]  # Increased for LSTM - handles complex temporal patterns

  # Checkpointing - adjusted for longer training
  checkpoint_freq: 50000  # Save every 50k timesteps (increased from 25k to reduce I/O)
  eval_freq: 50000  # Evaluate every 50k timesteps
  n_eval_episodes: 10  # Episodes per evaluation

  # OPTIMIZATION: Entropy decay over 10M training (LSTM learns faster with dense rewards)
  # Maintains exploration throughout learning
  entropy_schedule:
    enabled: true
    initial: 0.05  # Moderate initial exploration
    final: 0.001  # Low final entropy for precise terminal guidance
    decay_steps: 10000000  # Decay over full training duration (100%)
  
  lr_schedule:
    enabled: true
    patience: 5  # Evaluations without improvement
    factor: 0.5  # LR reduction factor
    min_lr: 0.000001
  
  clip_adapt:
    enabled: true
    threshold: 0.2  # Clip fraction threshold
    reduction: 0.75  # Clip range reduction factor
    min_clip: 0.05

# Inference configuration
inference:
  deterministic: true  # Use deterministic actions
  coordinate_system: "ENU"  # Default coordinate system
  
  # API settings
  host: "0.0.0.0"
  port: 8000
  cors_enabled: true
  
  # Performance
  max_batch_size: 32
  timeout_ms: 100

# Logging configuration
logging:
  log_dir: "logs"
  
  # Episode logging
  episode_logging:
    enabled: true
    log_interval: 100  # Log every N episodes
    save_trajectories: true
  
  # Metrics
  metrics:
    log_to_file: true
    log_to_tensorboard: true
    log_interval: 1000  # Log metrics every N steps
  
  # System logging
  system:
    level: "INFO"  # DEBUG, INFO, WARNING, ERROR
    format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

# Checkpointing
checkpointing:
  checkpoint_dir: "checkpoints"
  save_vecnormalize: true
  keep_last_n: 5  # Keep last N checkpoints
  save_best: true  # Save best model separately

# Safety constraints
safety:
  max_acceleration: 200.0  # m/s^2 (increased for realistic interceptor performance)
  max_angular_rate: 5.0  # rad/s
  max_gimbal_angle: 0.785  # 45 degrees in radians
  min_thrust: 0.0
  max_thrust: 1.0
  fuel_depletion_rate: 0.2  # kg/s at max thrust (increased with higher thrust)

# Advanced Physics v2.0 Configuration
physics_enhancements:
  # Enable/disable physics features for backward compatibility
  enabled: true  # Master switch for all advanced physics

  # Atmospheric modeling (ISA - International Standard Atmosphere)
  atmospheric_model:
    enabled: true
    # Sea level conditions (ISA standard)
    sea_level_pressure: 101325.0  # Pa
    sea_level_temperature: 288.15  # K (15°C)
    sea_level_density: 1.225  # kg/m³

    # Atmospheric layers
    troposphere_lapse_rate: 0.0065  # K/m
    troposphere_top: 11000.0  # m
    stratosphere_top: 20000.0  # m
    stratosphere_temp: 216.65  # K

    # Gas constants
    specific_gas_constant: 287.05  # J/(kg⋅K)
    gamma: 1.4  # Heat capacity ratio for air

  # Sensor delays and measurement lag
  # NOTE: Disabled initially for easier learning. Enable after initial training succeeds.
  sensor_delays:
    enabled: false  # Start without delays for curriculum learning
    radar_delay_ms: 30.0  # Radar processing delay in milliseconds (when enabled)
    # Buffer size automatically calculated from delay and simulation timestep

  # Mach-dependent drag effects (disabled for baseline training)
  mach_effects:
    enabled: false  # Disable complex drag for initial learning
    # Drag curve parameters
    subsonic_mach: 0.8  # Mach number where transonic effects begin
    supersonic_mach: 1.2  # Mach number where supersonic regime starts
    transonic_peak_multiplier: 3.0  # Peak drag multiplier in transonic regime
    supersonic_multiplier: 2.5  # Steady supersonic drag multiplier

  # Thrust dynamics and engine response (disabled for baseline training)
  thrust_dynamics:
    enabled: false  # Disable thrust lag for initial learning
    response_time_constant: 0.1  # seconds (100ms response time)
    # Thrust curve variations (future enhancement)
    enable_thrust_curves: false

  # Domain randomization for robust training
  domain_randomization:
    enabled: false  # Disabled by default - can impact training stability

    # Randomization ranges (as fractions of base values)
    drag_coefficient_variation: 0.2  # ±20%
    air_density_variation: 0.1  # ±10%
    sensor_delay_variation: 0.5  # ±50%
    thrust_response_variation: 0.3  # ±30%
    wind_variation: 0.3  # ±30%

    # Randomization frequency
    randomize_per_episode: true
    randomize_per_reset: true

    # Logging
    log_randomization: true

  # Enhanced wind modeling (disabled for baseline training)
  enhanced_wind:
    enabled: false  # Disable complex wind for initial learning
    boundary_layer_height: 1000.0  # m
    surface_roughness: 0.1  # m
    turbulence_intensity: 0.1  # 10% baseline
    gust_probability: 0.001  # Per timestep probability of gust
    max_gust_speed: 5.0  # m/s

  # Performance and debugging
  performance:
    log_physics_timing: false  # Log computation time per physics step
    max_physics_time_ms: 10.0  # Warning threshold for physics computation
    enable_physics_validation: true  # Validate physics outputs for NaN/inf

  # Backward compatibility
  fallback_to_simple_physics: true  # Fall back if advanced physics fails